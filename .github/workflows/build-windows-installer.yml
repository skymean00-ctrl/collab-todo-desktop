name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.1.0 등 태그 푸시 시 자동 빌드
  workflow_dispatch:  # 수동 실행도 가능
    inputs:
      version:
        description: '버전 (예: 1.0.0)'
        required: false
        default: '1.0.0'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # GitHub Releases 업로드 권한

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # v 접두사 제거
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building version: $VERSION"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller==6.11.1

      - name: Build standalone executable with PyInstaller
        run: |
          pyinstaller pyinstaller.spec --clean --noconfirm
          echo "--- Build output ---"
          dir dist

      - name: Verify executable exists
        shell: bash
        run: |
          if [ ! -f "dist/CollabToDoDesktop.exe" ]; then
            echo "ERROR: CollabToDoDesktop.exe not found in dist/"
            exit 1
          fi
          FILE_SIZE=$(stat -c%s "dist/CollabToDoDesktop.exe" 2>/dev/null || stat -f%z "dist/CollabToDoDesktop.exe")
          echo "Executable size: $FILE_SIZE bytes"
          if [ "$FILE_SIZE" -lt 1000000 ]; then
            echo "WARNING: Executable seems too small, may be missing dependencies"
          fi

      - name: Install Inno Setup
        run: |
          choco install innosetup --yes --no-progress
          echo "Inno Setup installed"

      - name: Update installer version
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $content = Get-Content "installer.iss" -Raw
          $content = $content -replace '#define AppVersion "1.0.0"', "#define AppVersion `"$version`""
          $content = $content -replace 'OutputBaseFilename=CollabTodoDesktop-Setup-1.0.0', "OutputBaseFilename=CollabTodoDesktop-Setup-$version"
          Set-Content "installer.iss" -Value $content
          echo "Updated installer.iss to version $version"

      - name: Build installer with Inno Setup
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
          echo "--- Installer output ---"
          dir installer

      - name: Verify installer
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          INSTALLER="installer/CollabTodoDesktop-Setup-${VERSION}.exe"
          if [ ! -f "$INSTALLER" ]; then
            echo "ERROR: Installer not found at $INSTALLER"
            ls -la installer/ || true
            exit 1
          fi
          FILE_SIZE=$(stat -c%s "$INSTALLER" 2>/dev/null || stat -f%z "$INSTALLER")
          echo "Installer size: $FILE_SIZE bytes"
          echo "Build successful!"

      - name: Upload installer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: CollabTodoDesktop-Setup-${{ steps.version.outputs.version }}
          path: installer/CollabTodoDesktop-Setup-${{ steps.version.outputs.version }}.exe
          retention-days: 30

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          name: "Collab Todo Desktop v${{ steps.version.outputs.version }}"
          body: |
            ## Collab Todo Desktop v${{ steps.version.outputs.version }}

            ### 설치 방법
            1. 아래 `CollabTodoDesktop-Setup-${{ steps.version.outputs.version }}.exe` 파일을 다운로드하세요.
            2. 다운로드한 파일을 실행하세요.
            3. 설치 마법사의 안내에 따라 설치하세요.
            4. 설치 완료 후 바탕화면 또는 시작 메뉴에서 실행하세요.

            ### 참고
            - **Python 설치 불필요** - 모든 의존성이 포함된 독립 실행형 설치 파일입니다.
            - **추가 프로그램 불필요** - 이 파일 하나만 설치하면 됩니다.
            - Windows 10 이상 권장
          files: |
            installer/CollabTodoDesktop-Setup-${{ steps.version.outputs.version }}.exe
          draft: false
          prerelease: false
