# 구현 계획서

> 작성일: 2026-02-19
> 기반: [MVP 기획안](./mvp-plan.md), 현재 코드베이스 분석

---

## 1. DB 스키마 변경

### 1.1 tasks 테이블 변경

기존 status ENUM에 `confirmed` 추가, 하위 업무 및 공개/비공개 지원:

```sql
ALTER TABLE tasks
  MODIFY COLUMN status ENUM(
    'pending',      -- 새 업무 (담당자 미확인)
    'confirmed',    -- 확인됨 (담당자가 기한 약속)
    'in_progress',  -- 진행중
    'review',       -- 검토 (기존 유지)
    'completed',    -- 완료
    'on_hold',      -- 보류
    'cancelled'     -- 취소
  ) NOT NULL DEFAULT 'pending',
  ADD COLUMN parent_task_id   BIGINT UNSIGNED NULL AFTER project_id,
  ADD COLUMN confirmed_at     DATETIME NULL AFTER due_date,
  ADD COLUMN promised_date    DATETIME NULL AFTER confirmed_at,
  ADD COLUMN is_private       TINYINT(1) NOT NULL DEFAULT 0 AFTER promised_date,
  ADD CONSTRAINT fk_tasks_parent FOREIGN KEY (parent_task_id) REFERENCES tasks(id)
    ON DELETE CASCADE ON UPDATE CASCADE,
  ADD INDEX idx_tasks_parent (parent_task_id);
```

| 새 컬럼 | 설명 |
|---------|------|
| `parent_task_id` | 상위 업무 ID (NULL이면 최상위 업무) |
| `confirmed_at` | 담당자가 "확인" 버튼 누른 시각 |
| `promised_date` | 담당자가 약속한 완료 기한 ("○월 ○일까지 하겠습니다") |
| `is_private` | 0 = 전체 공개 (기본), 1 = 관련자만 열람 가능 |

### 1.2 task_attachments 테이블 (신규)

```sql
CREATE TABLE IF NOT EXISTS task_attachments (
    id            BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    task_id       BIGINT UNSIGNED NOT NULL,
    uploader_id   BIGINT UNSIGNED NOT NULL,
    file_name     VARCHAR(255)    NOT NULL,
    file_path     VARCHAR(500)    NOT NULL,
    file_size     BIGINT UNSIGNED NOT NULL DEFAULT 0,
    mime_type     VARCHAR(100)    NULL,
    created_at    TIMESTAMP       NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id),
    CONSTRAINT fk_attachments_task FOREIGN KEY (task_id) REFERENCES tasks(id)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_attachments_uploader FOREIGN KEY (uploader_id) REFERENCES users(id)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_attachments_task (task_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 1.3 task_viewers 테이블 (신규) — 비공개 업무 열람 권한

```sql
CREATE TABLE IF NOT EXISTS task_viewers (
    id        BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    task_id   BIGINT UNSIGNED NOT NULL,
    user_id   BIGINT UNSIGNED NOT NULL,
    PRIMARY KEY (id),
    UNIQUE KEY uk_task_viewer (task_id, user_id),
    CONSTRAINT fk_viewers_task FOREIGN KEY (task_id) REFERENCES tasks(id)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_viewers_user FOREIGN KEY (user_id) REFERENCES users(id)
        ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**공개/비공개 동작 방식:**
- `is_private = 0` (기본): 모든 팀원이 볼 수 있음 → task_viewers 무시
- `is_private = 1`: task_viewers에 등록된 사용자 + 지시자 + 담당자만 열람 가능
- 업무 생성 시 "비공개"를 체크하면 열람 가능 인원을 선택하는 UI 표시

### 1.4 users 테이블 활용

기존 스키마로 충분:
- `is_active = 0` → 가입 신청 (승인 대기)
- `is_active = 1` → 관리자 승인 완료
- `role = 'admin'` → 관리자 (가입 승인 권한)
- `password_hash` → 이미 존재

---

## 2. 업무 상태 흐름

```
                    ┌──────────────┐
                    │   pending    │  업무 등록 → 담당자에게 알림
                    │  (새 업무)    │
                    └──────┬───────┘
                           │ 담당자가 [확인] + 기한 약속
                           ▼
                    ┌──────────────┐
                    │  confirmed   │  "확인했습니다. ○일까지 하겠습니다"
                    │   (확인됨)    │
                    └──────┬───────┘
                           │ 담당자가 [작업 시작]
                           ▼
                    ┌──────────────┐
                    │ in_progress  │  실제 작업 진행 중
                    │  (진행중)     │  (이 단계에서 자료 요청 생성 가능)
                    └──────┬───────┘
                           │ 담당자가 [완료 보고] + 파일 첨부
                           ▼
                    ┌──────────────┐
                    │  completed   │  완료됨
                    │   (완료)     │
                    └──────────────┘
```

---

## 3. 화면 상세 설계

### 3.1 로그인 화면

```
┌──────────────────────────────────────┐
│                                      │
│         업무 관리 시스템               │
│                                      │
│    ┌──────────────────────────┐      │
│    │ 아이디                    │      │
│    └──────────────────────────┘      │
│    ┌──────────────────────────┐      │
│    │ 비밀번호                  │      │
│    └──────────────────────────┘      │
│                                      │
│    [       로그인       ]            │
│                                      │
│    계정이 없으신가요? [가입 신청]      │
│                                      │
└──────────────────────────────────────┘
```

**동작:**
- 로그인 성공 → 대시보드로 이동
- `is_active = 0`인 경우 → "승인 대기 중입니다" 메시지
- 실패 → "아이디 또는 비밀번호를 확인하세요"

### 3.2 가입 신청 화면

```
┌──────────────────────────────────────┐
│                                      │
│           가입 신청                   │
│                                      │
│    이름     ┌─────────────────┐      │
│             │                 │      │
│             └─────────────────┘      │
│    아이디   ┌─────────────────┐      │
│             │                 │      │
│             └─────────────────┘      │
│    비밀번호 ┌─────────────────┐      │
│             │                 │      │
│             └─────────────────┘      │
│    비번확인 ┌─────────────────┐      │
│             │                 │      │
│             └─────────────────┘      │
│                                      │
│    [      가입 신청      ]           │
│                                      │
│    이미 계정이 있으신가요? [로그인]    │
│                                      │
└──────────────────────────────────────┘
```

**동작:**
- `is_active = 0`으로 생성 → "가입 신청이 완료되었습니다. 관리자 승인 후 사용 가능합니다."

### 3.3 대시보드 (메인 화면) — 내 업무 탭

```
┌──────────────────────────────────────────────────────────────┐
│  업무 관리 시스템 — 박과장                    [알림 🔔 3]    │
├──────────────────────────────────────────────────────────────┤
│  [내 업무]  [내가 지시한 업무]  [전체 현황]                    │
├──────────────────────────────────────────────────────────────┤
│                                                [+ 새 업무]   │
│                                                              │
│  ── 확인 필요 (2건) ─────────────────────────────────────    │
│  ┌────────────────────────────────────────────────────┐     │
│  │ ⚪ 3공구 견적서 작성                                │     │
│  │   지시: 김팀장 · 마감: 2/25                         │     │
│  ├────────────────────────────────────────────────────┤     │
│  │ ⚪ 자재 발주서 확인                                 │     │
│  │   지시: 김팀장 · 마감: 2/21                         │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ── 진행중 (1건) ────────────────────────────────────────    │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 🔵 2공구 도면 검토           약속일: 2/23           │     │
│  │   지시: 이부장 · 마감: 2/24                         │     │
│  │   자료요청: 2/3 완료                                │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ── 완료 (5건) ──────────────────────────── [더보기 >]       │
│  ┌────────────────────────────────────────────────────┐     │
│  │ ✅ 1공구 안전점검표 제출        완료: 2/18          │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
├──────────────────────────────────────────────────────────────┤
│  DB: 연결됨                    마지막 동기화: 14:32:15       │
└──────────────────────────────────────────────────────────────┘
```

### 3.4 대시보드 — 내가 지시한 업무 탭

```
├──────────────────────────────────────────────────────────────┤
│  [내 업무]  [내가 지시한 업무]  [전체 현황]                    │
├──────────────────────────────────────────────────────────────┤
│                                                [+ 새 업무]   │
│                                                              │
│  ── 미확인 (1건) ────────────────────────────────────────    │
│  ┌────────────────────────────────────────────────────┐     │
│  │ ⚠️ 자재 발주서 확인              담당: 최사원       │     │
│  │   마감: 2/21 · 등록: 2시간 전 · 아직 미확인         │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ── 진행중 (2건) ────────────────────────────────────────    │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 🔵 3공구 견적서 작성              담당: 박과장      │     │
│  │   마감: 2/25 · 약속: 2/24 · 자료: 1/3 완료         │     │
│  ├────────────────────────────────────────────────────┤     │
│  │ 🔵 월간 보고서                    담당: 이대리      │     │
│  │   마감: 2/28 · 약속: 2/27                          │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
```

### 3.5 업무 상세 화면

```
┌──────────────────────────────────────────────────────────────┐
│  [← 뒤로]                                                    │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  3공구 견적서 작성                                            │
│  상태: 진행중                          마감: 2026-02-25      │
│                                                              │
│  지시자: 김팀장                                               │
│  담당자: 박과장                                               │
│  확인일: 2026-02-19 10:30              약속일: 2026-02-24    │
│                                                              │
│  ─── 설명 ───────────────────────────────────────────────    │
│  3공구 추가 공사 관련 견적서를 작성해서 제출해주세요.           │
│  도면, 소요시간, 자재단가를 취합하여 작성 바랍니다.            │
│                                                              │
│  ─── 자료 요청 ──────────────────────── [+ 자료 요청]       │
│  ┌────────────────────────────────────────────────────┐     │
│  │ ✅ 도면 보내주세요          → 이대리    완료 2/20   │     │
│  │    📎 3공구_도면_v2.dwg                             │     │
│  ├────────────────────────────────────────────────────┤     │
│  │ 🔵 소요시간 확인 부탁       → 박주임    진행중      │     │
│  ├────────────────────────────────────────────────────┤     │
│  │ ⚪ 자재 단가표 보내주세요   → 최사원    미확인      │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ─── 첨부 파일 ──────────────────────── [+ 파일 추가]       │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 📎 3공구_도면_v2.dwg       이대리    2/20 14:30    │     │
│  │ 📎 참고_견적서_양식.xlsx    김팀장    2/19 09:00    │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ─── 이력 ───────────────────────────────────────────────    │
│  2/19 09:00  김팀장이 업무를 등록했습니다                      │
│  2/19 10:30  박과장이 확인했습니다 (2/24까지 완료 약속)        │
│  2/19 10:35  박과장이 이대리에게 도면을 요청했습니다            │
│  2/20 14:30  이대리가 도면을 첨부하고 완료했습니다              │
│                                                              │
│  ────────────────────────────────────────────────────────    │
│                                                              │
│  (담당자 본인일 때 표시되는 버튼)                              │
│  [확인하기]  [작업 시작]  [완료 보고]                          │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 3.6 업무 생성 화면

```
┌──────────────────────────────────────────────────────────────┐
│  [← 뒤로]                                                    │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  새 업무 등록                                                 │
│                                                              │
│  제목 *    ┌──────────────────────────────────┐              │
│            │                                  │              │
│            └──────────────────────────────────┘              │
│                                                              │
│  설명      ┌──────────────────────────────────┐              │
│            │                                  │              │
│            │                                  │              │
│            │                                  │              │
│            └──────────────────────────────────┘              │
│                                                              │
│  담당자 *  ┌──────────────────────────────────┐              │
│            │ ▼ 선택하세요                      │              │
│            └──────────────────────────────────┘              │
│                                                              │
│  마감일 *  ┌──────────────────────────────────┐              │
│            │ 📅 2026-02-25                    │              │
│            └──────────────────────────────────┘              │
│                                                              │
│  첨부파일  ┌──────────────────────────────────┐              │
│            │ [파일 선택]  선택된 파일 없음      │              │
│            └──────────────────────────────────┘              │
│                                                              │
│            [       업무 등록       ]                          │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 3.7 알림 목록

```
┌──────────────────────────────────────────────────────────────┐
│  알림                                      [모두 읽음 처리]  │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ● 새 업무가 배정되었습니다                     5분 전       │
│    "3공구 견적서 작성" — 김팀장                               │
│                                                              │
│  ● 자료 요청이 도착했습니다                     1시간 전     │
│    "도면 보내주세요" — 박과장                                 │
│                                                              │
│  ○ 업무가 완료되었습니다                        어제         │
│    "1공구 안전점검표" — 이대리                                │
│                                                              │
│  ○ 마감이 임박합니다                            어제         │
│    "자재 발주서 확인" — 마감: 내일                            │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

`●` = 안 읽음, `○` = 읽음. 클릭하면 해당 업무 상세로 이동.

### 3.8 사용자 관리 (관리자 전용)

```
┌──────────────────────────────────────────────────────────────┐
│  사용자 관리                                                  │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ── 승인 대기 (2명) ─────────────────────────────────────    │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 홍길동 (hong123)         신청: 2/19               │     │
│  │                          [승인]  [거절]            │     │
│  ├────────────────────────────────────────────────────┤     │
│  │ 김철수 (kim456)          신청: 2/18               │     │
│  │                          [승인]  [거절]            │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
│  ── 활성 사용자 (8명) ───────────────────────────────────    │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 김팀장 (kimtl)           관리자        가입: 1/15  │     │
│  │ 박과장 (park01)          팀원          가입: 1/15  │     │
│  │ 이대리 (lee02)           팀원          가입: 1/16  │     │
│  │ ...                                               │     │
│  └────────────────────────────────────────────────────┘     │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 4. 구현 순서 (로드맵)

### Phase 1: 기반 (1~2일)

| # | 작업 | 설명 |
|---|------|------|
| 1-1 | DB 스키마 마이그레이션 | tasks 변경 + task_attachments 추가 |
| 1-2 | 모델 업데이트 | Task에 parent_task_id, confirmed_at, promised_date 추가 |
| 1-3 | 리포지토리 확장 | 인증, 하위업무, 첨부파일 CRUD |

### Phase 2: 인증 (1~2일)

| # | 작업 | 설명 |
|---|------|------|
| 2-1 | 로그인 화면 | ID/비밀번호 입력 → 인증 |
| 2-2 | 가입 신청 화면 | 가입 → is_active=0 |
| 2-3 | 사용자 관리 화면 | 관리자: 승인/거절 |

### Phase 3: 핵심 업무 흐름 (3~4일)

| # | 작업 | 설명 |
|---|------|------|
| 3-1 | 대시보드 (내 업무) | 상태별 업무 목록 |
| 3-2 | 대시보드 (내가 지시한 업무) | 지시자 관점 목록 |
| 3-3 | 업무 생성 화면 | 제목, 설명, 담당자, 마감일 |
| 3-4 | 업무 상세 화면 | 상세 정보 + 상태 변경 버튼 |
| 3-5 | 확인 + 기한 약속 | "확인하기" 버튼 → promised_date 입력 |

### Phase 4: 자료 요청 & 파일 (2~3일)

| # | 작업 | 설명 |
|---|------|------|
| 4-1 | 자료 요청 (하위 업무) | 업무 상세에서 자료 요청 생성 |
| 4-2 | 파일 첨부/다운로드 | 업무에 파일 첨부, 목록 표시, 다운로드 |
| 4-3 | 파일 저장소 | 로컬 or 공유 폴더 경로 설정 |

### Phase 5: 알림 & 마무리 (1~2일)

| # | 작업 | 설명 |
|---|------|------|
| 5-1 | 앱 내 알림 목록 | 알림 화면 |
| 5-2 | PC 데스크톱 팝업 | 시스템 트레이 알림 |
| 5-3 | 전체 현황 탭 | 관리자용 전체 업무 조회 |

---

## 5. 기술 결정 사항

| 항목 | 결정 | 이유 |
|------|------|------|
| 프레임워크 | PyQt5 (기존 유지) | 이미 구축되어 있음 |
| DB | MySQL (기존 유지) | NAS 연결, 이미 설정됨 |
| 인증 | bcrypt (password_hash) | 단순하고 안전 |
| 파일 저장 | 공유 폴더 (NAS) | 건설 현장에서 NAS 사용 중 |
| 알림 | QSystemTrayIcon | PyQt5 내장, 추가 라이브러리 불필요 |

---

## 6. 파일 구조 (예상)

> **원칙: 한 파일에 코드를 길게 작성하지 않는다. 기능별로 최대한 세분화한다.**

```
collab_todo/
├── __init__.py
├── config.py                # (기존) 설정 로드
├── db.py                    # (기존) DB 연결
├── sync.py                  # (기존) 동기화
├── dashboard.py             # (기존) 요약 통계
├── ai_client.py             # (기존) AI 요약
│
├── models/                  # 도메인 모델 (기존 models.py → 패키지로 분리)
│   ├── __init__.py          # 전체 모델 re-export
│   ├── user.py              # User 모델
│   ├── project.py           # Project 모델
│   ├── task.py              # Task 모델
│   ├── task_attachment.py   # TaskAttachment 모델 (신규)
│   ├── task_history.py      # TaskHistory 모델
│   └── notification.py      # Notification 모델
│
├── repositories/            # 데이터 접근 (기존 repositories.py → 패키지로 분리)
│   ├── __init__.py          # 전체 re-export
│   ├── user_repo.py         # 사용자 조회/생성
│   ├── project_repo.py      # 프로젝트 조회
│   ├── task_repo.py         # 업무 CRUD
│   ├── subtask_repo.py      # 하위 업무(자료요청) CRUD
│   ├── viewer_repo.py       # 비공개 업무 열람 권한 CRUD
│   ├── attachment_repo.py   # 첨부파일 CRUD
│   ├── history_repo.py      # 업무 이력 조회
│   └── notification_repo.py # 알림 CRUD
│
├── services/                # 비즈니스 로직 (신규)
│   ├── __init__.py
│   ├── auth_service.py      # 로그인, 가입, 비밀번호 해싱
│   ├── task_service.py      # 업무 상태 변경, 확인, 완료 처리
│   ├── subtask_service.py   # 자료 요청 생성/완료 로직
│   ├── file_service.py      # 파일 저장/조회/다운로드
│   └── notification_service.py # 알림 생성/발송 로직
│
├── ui/                      # UI 모듈 (신규)
│   ├── __init__.py
│   ├── main_window.py       # 메인 윈도우 (화면 전환 컨테이너)
│   ├── styles.py            # 공통 스타일 (글꼴, 색상, 간격)
│   │
│   ├── auth/                # 인증 관련 화면
│   │   ├── __init__.py
│   │   ├── login_view.py    # 로그인 화면
│   │   └── register_view.py # 가입 신청 화면
│   │
│   ├── dashboard/           # 대시보드 화면
│   │   ├── __init__.py
│   │   ├── my_tasks_tab.py  # 내 업무 탭
│   │   ├── sent_tasks_tab.py # 내가 지시한 업무 탭
│   │   ├── all_tasks_tab.py # 전체 현황 탭
│   │   └── task_card.py     # 업무 카드 위젯 (재사용)
│   │
│   ├── task/                # 업무 관련 화면
│   │   ├── __init__.py
│   │   ├── task_detail_view.py    # 업무 상세
│   │   ├── task_create_view.py    # 업무 생성
│   │   ├── task_confirm_dialog.py # 확인+기한약속 다이얼로그
│   │   ├── subtask_list.py        # 자료 요청 목록 위젯
│   │   ├── subtask_create_dialog.py # 자료 요청 생성 다이얼로그
│   │   ├── attachment_list.py     # 첨부파일 목록 위젯
│   │   └── history_list.py        # 이력 목록 위젯
│   │
│   ├── notification/        # 알림 관련 화면
│   │   ├── __init__.py
│   │   ├── notification_view.py   # 알림 목록 화면
│   │   ├── notification_badge.py  # 알림 배지 (숫자 표시)
│   │   └── tray_notifier.py       # 시스템 트레이 팝업 알림
│   │
│   └── admin/               # 관리자 화면
│       ├── __init__.py
│       └── user_manage_view.py # 사용자 관리 (승인/거절)
│
sql/
├── schema_mysql.sql         # (수정) 스키마 업데이트
└── migration_v2.sql         # (신규) 마이그레이션 스크립트
```

### 세분화 원칙

1. **한 파일 = 한 책임**: 하나의 화면, 하나의 위젯, 하나의 DB 테이블
2. **200줄 이하 목표**: 한 파일이 200줄을 넘으면 분리 검토
3. **재사용 위젯 분리**: task_card, attachment_list 등은 여러 화면에서 사용
4. **계층 분리**: models → repositories → services → ui (단방향 의존)
